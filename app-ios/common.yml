settingGroups:
  codeSigning:
    base:
      CODE_SIGN_IDENTITY: "$(inherited)"
      CODE_SIGN_ENTITLEMENTS: "$(TARGET_NAME)/$(TARGET_NAME)$(CONFIGURATION).entitlements"
    configs:
      Debug Production:
        CODE_SIGN_ENTITLEMENTS: "$(TARGET_NAME)/$(TARGET_NAME).entitlements"
      Release Development:
        PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]: "match AdHoc ${bundleIdPrefix}.$(PRODUCT_NAME)"
      Release Staging:
        PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]: "match AdHoc $(PRODUCT_BUNDLE_IDENTIFIER)"
      Release Production:
        CODE_SIGN_ENTITLEMENTS: "$(TARGET_NAME)/$(TARGET_NAME).entitlements"
        PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]: "match AdHoc $(PRODUCT_BUNDLE_IDENTIFIER)"
  extension:
    base:
      SKIP_INSTALL: "YES"
      INFOPLIST_KEY_CFBundleDisplayName: "$(TARGET_NAME)"
      LD_RUNPATH_SEARCH_PATHS: "$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks"
      SWIFT_EMIT_LOC_STRINGS: "YES"
      GENERATE_INFOPLIST_FILE: "YES"
      CURRENT_PROJECT_VERSION: "1"
      MARKETING_VERSION: "1.0"
targets:
  argon2:
    type: "library.static"
    settings:
      PRODUCT_NAME: "argon2"
      # Don't show warnings for vendored code
      WARNING_CFLAGS: "-w"
    sources:
      - path: "TutanotaSharedFramework/Crypto/phc-winner-argon2"
        includes:
          [
            "src/argon2.c",
            "src/core.c",
            "src/encoding.c",
            "src/genkat.c",
            "src/ref.c",
            "src/blake2/blake2b.c",
          ]
        compilerFlags:
          [
            "-ITutanotaSharedFramework/Crypto/phc-winner-argon2/include",
            "-DARGON2_NO_THREADS",
            "-O3",
          ]
    platform: "iOS"
  TutanotaShareExtension:
    templates: ["formatAndLint"]
    type: "app-extension"
    sources: "TutanotaShareExtension"
    settings:
      base:
        PRODUCT_NAME: "TutanotaShareExtension"
        PRODUCT_BUNDLE_IDENTIFIER: "$(inherited).TutanotaShareExtension"
        IPHONEOS_DEPLOYMENT_TARGET: "15.5" # Why?
        INFOPLIST_FILE: "TutanotaShareExtension/Info.plist"
        HEADER_SEARCH_PATHS:           
          [
            "-I$(PROJECT_DIR)/TutanotaSharedFramework/Crypto/phc-winner-argon2/include",
          ]
        MARKETING_VERSION: "3.104.5"
        CLANG_CXX_LANGUAGE_STANDARD: "gnu++17"
        SUPPORTS_XR_DESIGNED_FOR_IPHONE_IPAD: "NO"
        SUPPORTS_MAC_DESIGNED_FOR_IPHONE_IPAD: "NO"
      groups:
        - "codeSigning"
        - "extension"
    dependencies:
      - target: "TutanotaSharedFramework"
      - framework: tutasdk.framework
        embed: false
  TutanotaSharedFramework:
    type: "framework"
    platform: "iOS"
    sources:
      - path: "TutanotaSharedFramework"
        headerVisibility: "public"
        # Exclude TUTBigNum.h so we change it's visiblity to 'project' in another source
        excludes: [
            "Crypto/TUTBigNum.h", 
            "*.md", 
            "Sql/sqlite3.c", 
            "Crypto/phc-winner-argon2",
          ]
        compilerFlags:
          [
            "-I$(PROJECT_DIR)/TutanotaSharedFramework/Crypto/phc-winner-argon2/include",
          ]
      - path: "TutanotaSharedFramework/Crypto"
        includes: ["TUTBigNum.h"]
        headerVisibility: "project"
      - path: "TutanotaSharedFramework/Crypto/phc-winner-argon2/include/"
        includes: ["argon2.h"]
        headerVisibility: "public"
      - path: "TutanotaSharedFramework/Sql"
        # Don't show warnings for vendored code
        includes: ["sqlite3.c"]
        compilerFlags: "-w"
    settings:
      PRODUCT_NAME: "TutanotaSharedFramework"
      PRODUCT_BUNDLE_IDENTIFIER: "$(inherited).TutanotaSharedFramework"
      INSTALL_PATH: "$(LOCAL_LIBRARY_DIR)/Frameworks"
      HEADER_SEARCH_PATHS:
        [
          "TutanotaSharedFramework/Crypto/phc-winner-argon2/include",
        ]   
      OTHER_CFLAGS[arch=*]:
        [
          "-DSQLITE_HAS_CODEC",
          "-DSQLITE_TEMP_STORE=3",
          "-DSQLCIPHER_CRYPTO_CC",
          "-DNDEBUG",
        ]
      GCC_PREPROCESSOR_DEFINITIONS: [
        "SQLITE_HAS_CODEC=1", 
        "$(inherited)"
      ]
      APPLICATION_EXTENSION_API_ONLY: "YES"
      ENABLE_USER_SCRIPT_SANDBOXING: "YES"
      SKIP_INSTALL: "YES"
      DYLIB_COMPATIBILITY_VERSION: "1"
      DYLIB_CURRENT_VERSION: "1"
      DYLIB_INSTALL_NAME_BASE: "@rpath"
      LD_RUNPATH_SEARCH_PATHS: "$(inherited) @executable_path/Frameworks @loader_path/Frameworks"
      LOCALIZATION_PREFERS_STRING_CATALOGS: "YES"
      SWIFT_EMIT_LOC_STRINGS: "YES"
      DEFINES_MODULE: "YES"
      GENERATE_INFOPLIST_FILE: "YES"
      CODE_SIGN_STYLE: "Manual"
      CODE_SIGN_IDENTITY: "$(inherited)"
      PROVISIONING_PROFILE_SPECIFIER: ""
      CURRENT_PROJECT_VERSION: "1"
      MARKETING_VERSION: "1.0"
      VERSIONING_SYSTEM: "apple-generic"
      GCC_NO_COMMON_BLOCKS: "YES"
      ENABLE_MODULE_VERIFIER: "YES"
      MODULE_VERIFIER_SUPPORTED_LANGUAGES: "objective-c objective-c++"
      MODULE_VERIFIER_SUPPORTED_LANGUAGE_STANDARDS: "$(GCC_C_LANGUAGE_STANDARD) $(CLANG_CXX_LANGUAGE_STANDARD)"
      SUPPORTS_XR_DESIGNED_FOR_IPHONE_IPAD: "NO"
      SUPPORTS_MAC_DESIGNED_FOR_IPHONE_IPAD: "NO"
      ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: "YES"
    dependencies:
      - package: DictionaryCoding
        product: "DictionaryCoding"
      - framework: libcrypto.xcframework
        embed: false
      - framework: tutasdk.framework
        embed: false
      - target: argon2
        link: true
  TutanotaNotificationExtension:
    type: "app-extension"
    platform: "iOS"
    sources:
      - path: "TutanotaNotificationExtension"
    settings:
      base:
        PRODUCT_NAME: "$(TARGET_NAME)"
        SUPPORTS_XR_DESIGNED_FOR_IPHONE_IPAD: "NO"
        SUPPORTS_MAC_DESIGNED_FOR_IPHONE_IPAD: "NO"
        GCC_NO_COMMON_BLOCKS: "YES"
        CLANG_CXX_LANGUAGE_STANDARD: "gnu++20"
        ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: "YES"
        ENABLE_USER_SCRIPT_SANDBOXING: "YES"
        LOCALIZATION_PREFERS_STRING_CATALOGS: "YES"
        INFOPLIST_FILE: "TutanotaNotificationExtension/Info.plist"
        PRODUCT_BUNDLE_IDENTIFIER: "$(inherited).TutanotaNotificationExtension"
      groups:
        - "codeSigning"
        - "extension"
    dependencies:
      - target: "TutanotaSharedFramework"
targetTemplates:
  formatAndLint:
    type: "application"
    platform: "iOS"
    supportedDestinations: ["iOS"]
    preBuildScripts:
      - path: "buildScripts/format.sh"
        name: "Check formating with swift-format"
        shell: "/bin/sh"
        showEnvVars: true
        basedOnDependencyAnalysis: false
    postCompileScripts:
      - path: "buildScripts/lint-xcode.sh"
        name: "Lint with SwiftLint"
        shell: "/bin/sh"
        showEnvVars: true
        basedOnDependencyAnalysis: false
schemes:
  TutanotaShareExtension:
    build:
      targets:
        TutanotaShareExtension: "all"
  TutanotaSharedFramework:
    build:
      targets:
        TutanotaSharedFramework: "all"
        TutanotaSharedTests: ["test"]
    test:
      targets: ["TutanotaSharedTests"]
packages:
  DictionaryCoding:
    url: https://github.com/elegantchaos/DictionaryCoding.git
    version: 1.0.9
  Mockingbird:
    url: https://github.com/birdrides/mockingbird.git
    version: 0.20.0
  Atomics:
    url: https://github.com/apple/swift-atomics.git
    version: 1.0.2
